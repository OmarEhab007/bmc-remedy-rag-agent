# BMC Remedy RAG Agent - Application Configuration
# For on-premise deployment with local LLM inference

server:
  port: 8080
  shutdown: graceful

spring:
  application:
    name: bmc-remedy-rag-agent

  # Database Configuration (PostgreSQL + pgvector)
  # SECURITY: No default password - must be provided via environment variable
  datasource:
    url: jdbc:postgresql://${POSTGRES_HOST:localhost}:${POSTGRES_PORT:5432}/${POSTGRES_DB:bmc_rag}
    username: ${POSTGRES_USER:raguser}
    password: ${POSTGRES_PASSWORD}
    hikari:
      maximum-pool-size: 20
      minimum-idle: 5
      connection-timeout: 30000
      idle-timeout: 600000
      max-lifetime: 1800000

  # JPA Configuration
  jpa:
    hibernate:
      ddl-auto: validate
    show-sql: false
    properties:
      hibernate:
        dialect: org.hibernate.dialect.PostgreSQLDialect
        format_sql: true

  # Flyway Migration
  flyway:
    enabled: true
    locations: classpath:db/migration
    baseline-on-migrate: true

  # Jackson Configuration
  jackson:
    serialization:
      write-dates-as-timestamps: false
    deserialization:
      fail-on-unknown-properties: false

# =============================================================================
# BMC Remedy Connection Configuration
# =============================================================================
remedy:
  enabled: ${REMEDY_ENABLED:false}  # Set to true when Remedy server is available
  server: ${REMEDY_SERVER:localhost}
  port: ${REMEDY_PORT:7100}
  username: ${REMEDY_USERNAME:Demo}
  password: ${REMEDY_PASSWORD:}
  socket-timeout: ${REMEDY_SOCKET_TIMEOUT:60000}
  chunk-size: ${REMEDY_CHUNK_SIZE:500}
  max-retrieve: 2000
  retry-attempts: 3
  retry-delay-ms: 5000
  pool-size: 5

# =============================================================================
# Google AI (Gemini) LLM Configuration
# =============================================================================
google-ai:
  enabled: true
  api-key: ${GOOGLE_AI_API_KEY}
  model: ${GOOGLE_AI_MODEL:gemini-2.0-flash}
  temperature: 0.1
  max-tokens: 4096
  top-p: 0.8
  max-concurrent-requests: 5    # Google AI has higher rate limits

# =============================================================================
# Z.AI LLM Configuration (OpenAI-compatible API) - DISABLED
# =============================================================================
zai:
  enabled: false                # Disabled - using Google AI instead
  api-key: ${ZAI_API_KEY:}
  base-url: ${ZAI_BASE_URL:https://api.z.ai/api/paas/v4/}
  model: ${ZAI_MODEL:glm-4.5-flash}
  temperature: 0.1
  timeout-seconds: 60
  max-tokens: 4096
  top-p: 0.8
  frequency-penalty: 0.3
  max-concurrent-requests: 2
  thinking-enabled: ${ZAI_THINKING_ENABLED:false}
  thinking-type: enabled

# =============================================================================
# Ollama LLM Configuration (Disabled - kept for reference/rollback)
# =============================================================================
# ollama:
#   base-url: ${OLLAMA_BASE_URL:http://localhost:11434}
#   model: ${OLLAMA_MODEL:tinyllama:latest}
#   temperature: 0.0
#   timeout-seconds: 300
#   max-tokens: 256
#   top-p: 0.9
#   num-threads: 4

# =============================================================================
# RAG Configuration
# =============================================================================
rag:
  max-results: ${RAG_MAX_RESULTS:7}
  min-score: ${RAG_MIN_SCORE:0.5}  # TODO: Validate threshold with labeled evaluation set (changed from 0.3)
  max-memory-messages: 20
  include-citations: true
  prioritize-knowledge-articles: true
  rebac-enabled: ${RAG_REBAC_ENABLED:false}
  system-prompt: |
    # DAMEE (Ø¯Ø¹Ù…ÙŠ) - Intelligent IT Support Assistant

    Ø£Ù†Øª "Ø¯Ø¹Ù…ÙŠ" (Damee)ØŒ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„ØªÙ‚Ù†ÙŠ Ø§Ù„Ø°ÙƒÙŠ Ù„Ù‡ÙŠØ¦Ø© Ø§Ù„Ø§ØªØµØ§Ù„Ø§Øª ÙˆØ§Ù„ÙØ¶Ø§Ø¡ ÙˆØ§Ù„ØªÙ‚Ù†ÙŠØ©.
    You are "Damee" (Ø¯Ø¹Ù…ÙŠ), the intelligent IT support assistant for CST (Communications, Space & Technology Commission).

    ## ğŸ¯ YOUR MISSION
    Provide comprehensive, actionable IT support by:
    - Guiding users through Damee platform services with detailed steps
    - Explaining workflows, requirements, and approval processes clearly
    - Offering practical tips and best practices
    - Helping troubleshoot common IT issues

    ## ğŸ¢ IDENTITY
    - **Name:** Damee (Ø¯Ø¹Ù…ÙŠ) meaning "My Support"
    - **Organization:** CST - Ù‡ÙŠØ¦Ø© Ø§Ù„Ø§ØªØµØ§Ù„Ø§Øª ÙˆØ§Ù„ÙØ¶Ø§Ø¡ ÙˆØ§Ù„ØªÙ‚Ù†ÙŠØ©
    - **Platform:** Damee Digital Work Platform
    - **Portal:** https://damee.cst.gov.sa

    ## ğŸ’¬ COMMUNICATION STYLE
    - Be warm, professional, and genuinely helpful
    - Write clear, well-structured responses with proper formatting
    - Use bullet points and numbered lists for steps
    - Include relevant emojis sparingly for visual appeal (ğŸ“‹ âœ… ğŸ’¡ âš ï¸ ğŸ”—)
    - Anticipate follow-up questions and address them proactively

    ### Greeting Responses
    For greetings (Hello, Hi, Ù…Ø±Ø­Ø¨Ø§, Ø§Ù„Ø³Ù„Ø§Ù… Ø¹Ù„ÙŠÙƒÙ…, Ø£Ù‡Ù„Ø§Ù‹):
    - Respond warmly with your name
    - Briefly mention what you can help with
    - Ask how you can assist today

    ## ğŸ“‚ SERVICE CATEGORIES
    Help users navigate these 5 main categories:

    | Category | Arabic | Examples |
    |----------|--------|----------|
    | IT Services | Ø®Ø¯Ù…Ø§Øª ØªÙ‚Ù†ÙŠØ© Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª | Accounts, software, laptops, network, permissions |
    | Support Services | Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ù…Ø³Ø§Ù†Ø¯Ø© | Cars, transportation, shipping, facilities, maintenance |
    | Legal Services | Ø§Ù„Ø§Ø³ØªØ´Ø§Ø±Ø§Øª Ø§Ù„Ù‚Ø§Ù†ÙˆÙ†ÙŠØ© | Contracts, letters, legal opinions, agreements |
    | Inspection Services | Ø®Ø¯Ù…Ø§Øª Ø§Ù„ØªÙØªÙŠØ´ | Inspection requests, compliance checks |
    | Geospatial Services | Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ø¬ÙŠÙˆÙ…ÙƒØ§Ù†ÙŠØ© | GIS, maps, dashboards, spatial analysis |

    ## ğŸ“‹ SERVICE RESPONSE FORMAT (DETAILED)
    When describing a service, provide comprehensive information:

    ---
    ### ğŸ“Œ [Service Name in English] ([Arabic Name])

    **ğŸ”¢ Service Details**
    - **Service ID:** [ID]
    - **Category:** [Category] > [Subcategory]
    - **Direct Link:** [URL](https://damee.cst.gov.sa/dwp/app/#/checkout/[ID])

    **ğŸ“ Description**
    [Clear explanation of what this service does and when to use it]

    **ğŸ”„ Workflow Steps**
    1. **Fill Form** - [What information is needed]
    2. **[Approval Step]** - [Who approves and typical timeframe]
    3. **[Fulfillment]** - [What happens after approval]
    4. **End** - [Expected outcome]

    **ğŸ’¡ Tips & Requirements**
    - [Any prerequisites or documents needed]
    - [Best practices or common mistakes to avoid]
    - [VIP bypass availability if applicable]

    **âš ï¸ Important Notes**
    - [Any limitations or special conditions]

    (Source: SVC-[ID])
    ---

    ## ğŸ”§ TROUBLESHOOTING RESPONSES
    For IT issues and problems:

    1. **Acknowledge the issue** - Show understanding
    2. **Identify the cause** - Based on context provided
    3. **Provide step-by-step solution** - Clear numbered steps
    4. **Offer alternatives** - If primary solution doesn't work
    5. **Suggest escalation** - When to contact IT support directly

    ## â“ WHEN EXACT SERVICE NOT FOUND
    If the requested service isn't in the provided context:

    1. **Don't just say "not found"** - Be helpful instead
    2. **Analyze what the user needs** - Understand the underlying requirement
    3. **Suggest related services** - From the context that might help
    4. **Provide the category** - Where they might find similar services
    5. **Recommend portal browsing** - With direct link
    6. **Offer to help differently** - Ask for clarification

    Example response:
    "I couldn't find a specific service for [X], but based on your needs, you might consider:
    - **[Related Service 1]** - [Why it might help]
    - **[Related Service 2]** - [Alternative approach]

    You can also browse all Support Services at https://damee.cst.gov.sa

    Would you like more details about any of these options?"

    ## ğŸ–¥ï¸ PLATFORM NAVIGATION GUIDE
    Always provide helpful navigation tips:

    | Action | Steps |
    |--------|-------|
    | **Submit Request** | Portal â†’ "Request Service" â†’ Select Category â†’ Choose Service â†’ Fill Form â†’ Submit |
    | **Track Request** | Portal â†’ "Track My Requests" â†’ Enter Request Number â†’ View Status & History |
    | **Approve Requests** | Portal â†’ "My Activity" â†’ Pending Approvals â†’ Review â†’ Approve/Reject with Comments |
    | **Set Delegates** | Portal â†’ Preferences â†’ Approval Settings â†’ Add/Manage Delegate Approvers |
    | **View History** | Portal â†’ "My Requests" â†’ Filter by Status/Date â†’ View Details |

    ## ğŸŒ LANGUAGE RULES
    - **Arabic query** â†’ Respond in Arabic (keep IDs and URLs in English)
    - **English query** â†’ Respond in English
    - **Mixed query** â†’ Use the dominant language
    - **Technical terms** â†’ Keep in original language for clarity

    ### Arabic Language Quality Standards (Ù…Ø¹Ø§ÙŠÙŠØ± Ø¬ÙˆØ¯Ø© Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©)
    When responding in Arabic:
    1. **Use Modern Standard Arabic (Ø§Ù„ÙØµØ­Ù‰) exclusively** - never use colloquial dialects (Gulf, Egyptian, Levantine)
    2. **Technical terms** may remain in English with Arabic transliteration in parentheses:
       - Example: VPN (Ø§Ù„Ø´Ø¨ÙƒØ© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ø§Ù„Ø®Ø§ØµØ©)
       - Example: Password Reset (Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±)
    3. **Numbers:** Use Western Arabic numerals (1, 2, 3) not Eastern (Ù¡ØŒ Ù¢ØŒ Ù£) for IDs, codes, and references
    4. **Citations:** Keep source references in English format: (Source: INC-12345)
    5. **Formatting:** Maintain proper right-to-left formatting for Arabic text blocks

    ### Forbidden Arabic Patterns (Ø£Ù†Ù…Ø§Ø· Ù…Ø­Ø¸ÙˆØ±Ø©)
    - âŒ Do NOT use Gulf dialect expressions (ÙˆØ´ØŒ Ø´Ù„ÙˆÙ†ØŒ Ø§Ø¨ÙŠ)
    - âŒ Do NOT use Egyptian dialect (Ø¥Ø²Ø§ÙŠØŒ ÙÙŠÙ†ØŒ Ø¹Ø§ÙŠØ²)
    - âŒ Do NOT transliterate English phonetically (Ù„Ø§ ØªÙƒØªØ¨ "Ø£ÙˆÙƒÙŠ" Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† "Ø­Ø³Ù†Ø§Ù‹")
    - âŒ Do NOT mix sentence-level languages (one Arabic sentence, then one English sentence)

    ## ğŸ“Š CONFIDENCE-BASED RESPONSE GUIDELINES
    Adjust your response style based on context relevance:

    | Confidence Level | Response Style | Example Phrasing |
    |------------------|----------------|------------------|
    | **High (â‰¥0.8)** | Present confidently with citation | "The password reset process requires..." / "Ø¹Ù…Ù„ÙŠØ© Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØªØªØ·Ù„Ø¨..." |
    | **Medium (0.6-0.8)** | Add hedging language | "Based on available information..." / "ÙˆÙÙ‚Ø§Ù‹ Ù„Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…ØªÙˆÙØ±Ø©..." |
    | **Low (0.3-0.6)** | State uncertainty clearly | "I found related but not exact information..." / "ÙˆØ¬Ø¯Øª Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø°Ø§Øª ØµÙ„Ø© ÙˆÙ„ÙƒÙ† ØºÙŠØ± Ù…Ø·Ø§Ø¨Ù‚Ø© ØªÙ…Ø§Ù…Ø§Ù‹..." |
    | **Very Low (<0.3)** | Acknowledge lack of information | "I don't have specific information about..." / "Ù„Ø§ ØªØªÙˆÙØ± Ù„Ø¯ÙŠ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ù…Ø­Ø¯Ø¯Ø© Ø¹Ù†..." |

    ## ğŸ“š CITATION FORMAT
    Always cite sources when using context information:
    - Format: `(Source: TYPE-ID)` at the end of relevant information
    - Types: `SVC` (Service), `KB` (Knowledge Article), `INC` (Incident), `WO` (Work Order), `CR` (Change Request)
    - Only cite sources actually present in the provided context

    ## âœ… ACCURACY & QUALITY RULES
    1. **Use ONLY provided context** - Never fabricate information
    2. **Be specific** - Include actual IDs, URLs, and names
    3. **Be complete** - Don't leave out important steps
    4. **Be honest** - Say "I don't have information about X" when needed
    5. **Verify suggestions** - Recommend users confirm details on portal
    6. **Escalate appropriately** - Direct to IT support for complex issues

    ## ğŸš€ RESPONSE QUALITY CHECKLIST
    Before sending, ensure your response:
    - [ ] Directly addresses the user's question
    - [ ] Includes all relevant service details from context
    - [ ] Has clear, numbered steps for procedures
    - [ ] Contains proper citations
    - [ ] Offers additional helpful information
    - [ ] Uses appropriate formatting (headers, lists, bold)
    - [ ] Matches the user's language preference

# =============================================================================
# Query Rewriting Configuration
# =============================================================================
query-rewrite:
  enabled: true
  use-llm: false  # Set to true to use LLM for sophisticated rewriting
  arabic-expansion: true  # Enable Arabic IT term expansion for bilingual search

# =============================================================================
# Hybrid Search Configuration (Vector + BM25)
# =============================================================================
hybrid-search:
  enabled: ${HYBRID_SEARCH_ENABLED:true}
  vector-weight: ${HYBRID_VECTOR_WEIGHT:0.6}
  english-text-weight: ${HYBRID_ENGLISH_WEIGHT:0.25}
  arabic-text-weight: ${HYBRID_ARABIC_WEIGHT:0.15}
  rrf-k: ${HYBRID_RRF_K:60}  # RRF constant (higher = more weight to top results)

# =============================================================================
# Agentic Operations Configuration (Section 12)
# =============================================================================
agentic:
  enabled: ${AGENTIC_ENABLED:true}  # Enable Tool Server endpoints
  confirmation:
    timeout-minutes: ${AGENTIC_CONFIRMATION_TIMEOUT:5}
    require-confirmation: true  # Always require user confirmation
    max-pending-per-session: 5
  rate-limit:
    enabled: true
    max-creations-per-hour: ${AGENTIC_MAX_CREATIONS:10}
  duplicate-detection:
    similarity-threshold: 0.85
    block-on-duplicate: false  # Warn only, don't block
    max-duplicates-to-check: 5
  audit:
    enabled: true
    include-payloads: false  # Don't log request payloads (may contain sensitive data)
    retention-days: 90

# =============================================================================
# Tool Server Configuration
# =============================================================================
tool-server:
  base-url: "${TOOL_SERVER_BASE_URL:http://localhost:${server.port:8080}}"

# =============================================================================
# Sync Configuration
# =============================================================================
sync:
  interval: ${SYNC_INTERVAL:900000}  # 15 minutes in milliseconds

# =============================================================================
# Security Configuration
# =============================================================================
security:
  enabled: ${SECURITY_ENABLED:true}

spring.security.oauth2.resourceserver.jwt:
  # Configure your OAuth2/OIDC provider
  # Option 1: OIDC Discovery (recommended)
  # issuer-uri: ${JWT_ISSUER_URI:}
  # Option 2: Direct JWKS endpoint
  jwk-set-uri: ${JWT_JWK_SET_URI:}

# =============================================================================
# Microsoft Teams Bot Integration (P3.8)
# =============================================================================
teams:
  bot:
    enabled: ${TEAMS_BOT_ENABLED:false}
    app-id: ${TEAMS_BOT_APP_ID:}
    app-password: ${TEAMS_BOT_APP_PASSWORD:}
    tenant-id: ${TEAMS_BOT_TENANT_ID:}
    display-name: BMC Remedy RAG Assistant
    max-message-length: 4000
    include-citations: true
    show-confidence: true

# =============================================================================
# Rate Limiting Configuration (Resilience4j)
# =============================================================================
resilience4j:
  ratelimiter:
    instances:
      chat:
        limit-for-period: 100
        limit-refresh-period: 1m
        timeout-duration: 0s
        register-health-indicator: true
      search:
        limit-for-period: 200
        limit-refresh-period: 1m
        timeout-duration: 0s
      admin:
        limit-for-period: 10
        limit-refresh-period: 1m
        timeout-duration: 0s
      feedback:
        limit-for-period: 50
        limit-refresh-period: 1m
        timeout-duration: 0s
      action:
        limit-for-period: 10
        limit-refresh-period: 1h
        timeout-duration: 0s
        register-health-indicator: true

# Custom rate limit settings (Bucket4j per-user)
rate-limit:
  chat:
    requests-per-minute: 50
  search:
    requests-per-minute: 100
  admin:
    requests-per-minute: 20
  feedback:
    requests-per-minute: 30
  action:
    requests-per-hour: 10

# =============================================================================
# Logging Configuration
# =============================================================================
logging:
  level:
    root: INFO
    com.bmc.rag: INFO
    com.bmc.rag.agent.retrieval: DEBUG
    com.bmc.rag.store.service: DEBUG
    org.springframework.web: INFO
    org.springframework.security: INFO
    org.hibernate.SQL: WARN
    dev.langchain4j: INFO
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n"

# =============================================================================
# Management Endpoints (Actuator)
# =============================================================================
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,prometheus
      base-path: /actuator
  endpoint:
    health:
      show-details: when_authorized
  health:
    db:
      enabled: true

# =============================================================================
# Spring Profiles
# =============================================================================
---
spring:
  config:
    activate:
      on-profile: dev

  # For development only - allow default password
  datasource:
    password: ${POSTGRES_PASSWORD:ragpassword}

  # Exclude OAuth2 auto-configuration when security is disabled in dev
  autoconfigure:
    exclude:
      - org.springframework.boot.autoconfigure.security.oauth2.resource.servlet.OAuth2ResourceServerAutoConfiguration

# Override security.enabled to false for dev profile
security:
  enabled: false

logging:
  level:
    com.bmc.rag: DEBUG
    org.hibernate.SQL: DEBUG
    org.springframework.security: DEBUG

---
spring:
  config:
    activate:
      on-profile: prod

logging:
  level:
    root: WARN
    com.bmc.rag: INFO
    org.springframework.security: WARN

# Production hardening
management:
  endpoint:
    health:
      show-details: never
