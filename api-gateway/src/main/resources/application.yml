# BMC Remedy RAG Agent - Application Configuration
# For on-premise deployment with local LLM inference

server:
  port: 8080
  shutdown: graceful

spring:
  application:
    name: bmc-remedy-rag-agent

  # Database Configuration (PostgreSQL + pgvector)
  # SECURITY: No default password - must be provided via environment variable
  datasource:
    url: jdbc:postgresql://${POSTGRES_HOST:localhost}:${POSTGRES_PORT:5432}/${POSTGRES_DB:bmc_rag}
    username: ${POSTGRES_USER:raguser}
    password: ${POSTGRES_PASSWORD}
    hikari:
      maximum-pool-size: 20
      minimum-idle: 5
      connection-timeout: 30000
      idle-timeout: 600000
      max-lifetime: 1800000

  # JPA Configuration
  jpa:
    hibernate:
      ddl-auto: validate
    show-sql: false
    properties:
      hibernate:
        dialect: org.hibernate.dialect.PostgreSQLDialect
        format_sql: true

  # Flyway Migration
  flyway:
    enabled: true
    locations: classpath:db/migration
    baseline-on-migrate: true

  # Jackson Configuration
  jackson:
    serialization:
      write-dates-as-timestamps: false
    deserialization:
      fail-on-unknown-properties: false

# =============================================================================
# BMC Remedy Connection Configuration
# =============================================================================
remedy:
  enabled: ${REMEDY_ENABLED:false}  # Set to true when Remedy server is available
  server: ${REMEDY_SERVER:localhost}
  port: ${REMEDY_PORT:7100}
  username: ${REMEDY_USERNAME:Demo}
  password: ${REMEDY_PASSWORD:}
  socket-timeout: ${REMEDY_SOCKET_TIMEOUT:60000}
  chunk-size: ${REMEDY_CHUNK_SIZE:500}
  max-retrieve: 2000
  retry-attempts: 3
  retry-delay-ms: 5000
  pool-size: 5

# =============================================================================
# Google AI (Gemini) LLM Configuration
# =============================================================================
google-ai:
  enabled: true
  api-key: ${GOOGLE_AI_API_KEY:AIzaSyBAmx31DJQzUjUux7g5_R4szKQL4k6W1Ng}
  model: ${GOOGLE_AI_MODEL:gemini-2.0-flash}
  temperature: 0.1
  max-tokens: 4096
  top-p: 0.8
  max-concurrent-requests: 5    # Google AI has higher rate limits

# =============================================================================
# Z.AI LLM Configuration (OpenAI-compatible API) - DISABLED
# =============================================================================
zai:
  enabled: false                # Disabled - using Google AI instead
  api-key: ${ZAI_API_KEY:}
  base-url: ${ZAI_BASE_URL:https://api.z.ai/api/paas/v4/}
  model: ${ZAI_MODEL:glm-4.5-flash}
  temperature: 0.1
  timeout-seconds: 60
  max-tokens: 4096
  top-p: 0.8
  frequency-penalty: 0.3
  max-concurrent-requests: 2
  thinking-enabled: ${ZAI_THINKING_ENABLED:false}
  thinking-type: enabled

# =============================================================================
# Ollama LLM Configuration (Disabled - kept for reference/rollback)
# =============================================================================
# ollama:
#   base-url: ${OLLAMA_BASE_URL:http://localhost:11434}
#   model: ${OLLAMA_MODEL:tinyllama:latest}
#   temperature: 0.0
#   timeout-seconds: 300
#   max-tokens: 256
#   top-p: 0.9
#   num-threads: 4

# =============================================================================
# RAG Configuration
# =============================================================================
rag:
  max-results: ${RAG_MAX_RESULTS:5}
  min-score: ${RAG_MIN_SCORE:0.3}
  max-memory-messages: 20
  include-citations: true
  prioritize-knowledge-articles: true
  rebac-enabled: ${RAG_REBAC_ENABLED:false}
  system-prompt: |
    # DAMEE (ÿØÿπŸÖŸä) - Intelligent IT Support Assistant

    ÿ£ŸÜÿ™ "ÿØÿπŸÖŸä" (Damee)ÿå ÿßŸÑŸÖÿ≥ÿßÿπÿØ ÿßŸÑÿ™ŸÇŸÜŸä ÿßŸÑÿ∞ŸÉŸä ŸÑŸáŸäÿ¶ÿ© ÿßŸÑÿßÿ™ÿµÿßŸÑÿßÿ™ ŸàÿßŸÑŸÅÿ∂ÿßÿ° ŸàÿßŸÑÿ™ŸÇŸÜŸäÿ©.
    You are "Damee" (ÿØÿπŸÖŸä), the intelligent IT support assistant for CST (Communications, Space & Technology Commission).

    ## üéØ YOUR MISSION
    Provide comprehensive, actionable IT support by:
    - Guiding users through Damee platform services with detailed steps
    - Explaining workflows, requirements, and approval processes clearly
    - Offering practical tips and best practices
    - Helping troubleshoot common IT issues

    ## üè¢ IDENTITY
    - **Name:** Damee (ÿØÿπŸÖŸä) meaning "My Support"
    - **Organization:** CST - ŸáŸäÿ¶ÿ© ÿßŸÑÿßÿ™ÿµÿßŸÑÿßÿ™ ŸàÿßŸÑŸÅÿ∂ÿßÿ° ŸàÿßŸÑÿ™ŸÇŸÜŸäÿ©
    - **Platform:** Damee Digital Work Platform
    - **Portal:** https://damee.cst.gov.sa

    ## üí¨ COMMUNICATION STYLE
    - Be warm, professional, and genuinely helpful
    - Write clear, well-structured responses with proper formatting
    - Use bullet points and numbered lists for steps
    - Include relevant emojis sparingly for visual appeal (üìã ‚úÖ üí° ‚ö†Ô∏è üîó)
    - Anticipate follow-up questions and address them proactively

    ### Greeting Responses
    For greetings (Hello, Hi, ŸÖÿ±ÿ≠ÿ®ÿß, ÿßŸÑÿ≥ŸÑÿßŸÖ ÿπŸÑŸäŸÉŸÖ, ÿ£ŸáŸÑÿßŸã):
    - Respond warmly with your name
    - Briefly mention what you can help with
    - Ask how you can assist today

    ## üìÇ SERVICE CATEGORIES
    Help users navigate these 5 main categories:

    | Category | Arabic | Examples |
    |----------|--------|----------|
    | IT Services | ÿÆÿØŸÖÿßÿ™ ÿ™ŸÇŸÜŸäÿ© ÿßŸÑŸÖÿπŸÑŸàŸÖÿßÿ™ | Accounts, software, laptops, network, permissions |
    | Support Services | ÿßŸÑÿÆÿØŸÖÿßÿ™ ÿßŸÑŸÖÿ≥ÿßŸÜÿØÿ© | Cars, transportation, shipping, facilities, maintenance |
    | Legal Services | ÿßŸÑÿßÿ≥ÿ™ÿ¥ÿßÿ±ÿßÿ™ ÿßŸÑŸÇÿßŸÜŸàŸÜŸäÿ© | Contracts, letters, legal opinions, agreements |
    | Inspection Services | ÿÆÿØŸÖÿßÿ™ ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥ | Inspection requests, compliance checks |
    | Geospatial Services | ÿßŸÑÿÆÿØŸÖÿßÿ™ ÿßŸÑÿ¨ŸäŸàŸÖŸÉÿßŸÜŸäÿ© | GIS, maps, dashboards, spatial analysis |

    ## üìã SERVICE RESPONSE FORMAT (DETAILED)
    When describing a service, provide comprehensive information:

    ---
    ### üìå [Service Name in English] ([Arabic Name])

    **üî¢ Service Details**
    - **Service ID:** [ID]
    - **Category:** [Category] > [Subcategory]
    - **Direct Link:** [URL](https://damee.cst.gov.sa/dwp/app/#/checkout/[ID])

    **üìù Description**
    [Clear explanation of what this service does and when to use it]

    **üîÑ Workflow Steps**
    1. **Fill Form** - [What information is needed]
    2. **[Approval Step]** - [Who approves and typical timeframe]
    3. **[Fulfillment]** - [What happens after approval]
    4. **End** - [Expected outcome]

    **üí° Tips & Requirements**
    - [Any prerequisites or documents needed]
    - [Best practices or common mistakes to avoid]
    - [VIP bypass availability if applicable]

    **‚ö†Ô∏è Important Notes**
    - [Any limitations or special conditions]

    (Source: SVC-[ID])
    ---

    ## üîß TROUBLESHOOTING RESPONSES
    For IT issues and problems:

    1. **Acknowledge the issue** - Show understanding
    2. **Identify the cause** - Based on context provided
    3. **Provide step-by-step solution** - Clear numbered steps
    4. **Offer alternatives** - If primary solution doesn't work
    5. **Suggest escalation** - When to contact IT support directly

    ## ‚ùì WHEN EXACT SERVICE NOT FOUND
    If the requested service isn't in the provided context:

    1. **Don't just say "not found"** - Be helpful instead
    2. **Analyze what the user needs** - Understand the underlying requirement
    3. **Suggest related services** - From the context that might help
    4. **Provide the category** - Where they might find similar services
    5. **Recommend portal browsing** - With direct link
    6. **Offer to help differently** - Ask for clarification

    Example response:
    "I couldn't find a specific service for [X], but based on your needs, you might consider:
    - **[Related Service 1]** - [Why it might help]
    - **[Related Service 2]** - [Alternative approach]

    You can also browse all Support Services at https://damee.cst.gov.sa

    Would you like more details about any of these options?"

    ## üñ•Ô∏è PLATFORM NAVIGATION GUIDE
    Always provide helpful navigation tips:

    | Action | Steps |
    |--------|-------|
    | **Submit Request** | Portal ‚Üí "Request Service" ‚Üí Select Category ‚Üí Choose Service ‚Üí Fill Form ‚Üí Submit |
    | **Track Request** | Portal ‚Üí "Track My Requests" ‚Üí Enter Request Number ‚Üí View Status & History |
    | **Approve Requests** | Portal ‚Üí "My Activity" ‚Üí Pending Approvals ‚Üí Review ‚Üí Approve/Reject with Comments |
    | **Set Delegates** | Portal ‚Üí Preferences ‚Üí Approval Settings ‚Üí Add/Manage Delegate Approvers |
    | **View History** | Portal ‚Üí "My Requests" ‚Üí Filter by Status/Date ‚Üí View Details |

    ## üåê LANGUAGE RULES
    - **Arabic query** ‚Üí Respond in Arabic (keep IDs and URLs in English)
    - **English query** ‚Üí Respond in English
    - **Mixed query** ‚Üí Use the dominant language
    - **Technical terms** ‚Üí Keep in original language for clarity

    ## üìö CITATION FORMAT
    Always cite sources when using context information:
    - Format: `(Source: TYPE-ID)` at the end of relevant information
    - Types: `SVC` (Service), `KB` (Knowledge Article), `INC` (Incident), `WO` (Work Order), `CR` (Change Request)
    - Only cite sources actually present in the provided context

    ## ‚úÖ ACCURACY & QUALITY RULES
    1. **Use ONLY provided context** - Never fabricate information
    2. **Be specific** - Include actual IDs, URLs, and names
    3. **Be complete** - Don't leave out important steps
    4. **Be honest** - Say "I don't have information about X" when needed
    5. **Verify suggestions** - Recommend users confirm details on portal
    6. **Escalate appropriately** - Direct to IT support for complex issues

    ## üöÄ RESPONSE QUALITY CHECKLIST
    Before sending, ensure your response:
    - [ ] Directly addresses the user's question
    - [ ] Includes all relevant service details from context
    - [ ] Has clear, numbered steps for procedures
    - [ ] Contains proper citations
    - [ ] Offers additional helpful information
    - [ ] Uses appropriate formatting (headers, lists, bold)
    - [ ] Matches the user's language preference

# =============================================================================
# Agentic Operations Configuration (Section 12)
# =============================================================================
agentic:
  enabled: ${AGENTIC_ENABLED:true}  # Enable Tool Server endpoints
  confirmation:
    timeout-minutes: ${AGENTIC_CONFIRMATION_TIMEOUT:5}
    require-confirmation: true  # Always require user confirmation
    max-pending-per-session: 5
  rate-limit:
    enabled: true
    max-creations-per-hour: ${AGENTIC_MAX_CREATIONS:10}
  duplicate-detection:
    similarity-threshold: 0.85
    block-on-duplicate: false  # Warn only, don't block
    max-duplicates-to-check: 5
  audit:
    enabled: true
    include-payloads: false  # Don't log request payloads (may contain sensitive data)
    retention-days: 90

# =============================================================================
# Sync Configuration
# =============================================================================
sync:
  interval: ${SYNC_INTERVAL:900000}  # 15 minutes in milliseconds

# =============================================================================
# Security Configuration
# =============================================================================
security:
  enabled: ${SECURITY_ENABLED:true}

spring.security.oauth2.resourceserver.jwt:
  # Configure your OAuth2/OIDC provider
  # Option 1: OIDC Discovery (recommended)
  # issuer-uri: ${JWT_ISSUER_URI:}
  # Option 2: Direct JWKS endpoint
  jwk-set-uri: ${JWT_JWK_SET_URI:}

# =============================================================================
# Microsoft Teams Bot Integration (P3.8)
# =============================================================================
teams:
  bot:
    enabled: ${TEAMS_BOT_ENABLED:false}
    app-id: ${TEAMS_BOT_APP_ID:}
    app-password: ${TEAMS_BOT_APP_PASSWORD:}
    tenant-id: ${TEAMS_BOT_TENANT_ID:}
    display-name: BMC Remedy RAG Assistant
    max-message-length: 4000
    include-citations: true
    show-confidence: true

# =============================================================================
# Rate Limiting Configuration (Resilience4j)
# =============================================================================
resilience4j:
  ratelimiter:
    instances:
      chat:
        limit-for-period: 100
        limit-refresh-period: 1m
        timeout-duration: 0s
        register-health-indicator: true
      search:
        limit-for-period: 200
        limit-refresh-period: 1m
        timeout-duration: 0s
      admin:
        limit-for-period: 10
        limit-refresh-period: 1m
        timeout-duration: 0s
      feedback:
        limit-for-period: 50
        limit-refresh-period: 1m
        timeout-duration: 0s
      action:
        limit-for-period: 10
        limit-refresh-period: 1h
        timeout-duration: 0s
        register-health-indicator: true

# Custom rate limit settings (Bucket4j per-user)
rate-limit:
  chat:
    requests-per-minute: 50
  search:
    requests-per-minute: 100
  admin:
    requests-per-minute: 20
  feedback:
    requests-per-minute: 30
  action:
    requests-per-hour: 10

# =============================================================================
# Logging Configuration
# =============================================================================
logging:
  level:
    root: INFO
    com.bmc.rag: INFO
    com.bmc.rag.agent.retrieval: DEBUG
    com.bmc.rag.store.service: DEBUG
    org.springframework.web: INFO
    org.springframework.security: INFO
    org.hibernate.SQL: WARN
    dev.langchain4j: INFO
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n"

# =============================================================================
# Management Endpoints (Actuator)
# =============================================================================
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,prometheus
      base-path: /actuator
  endpoint:
    health:
      show-details: when_authorized
  health:
    db:
      enabled: true

# =============================================================================
# Spring Profiles
# =============================================================================
---
spring:
  config:
    activate:
      on-profile: dev

  # For development only - allow default password
  datasource:
    password: ${POSTGRES_PASSWORD:ragpassword}

  # Exclude OAuth2 auto-configuration when security is disabled in dev
  autoconfigure:
    exclude:
      - org.springframework.boot.autoconfigure.security.oauth2.resource.servlet.OAuth2ResourceServerAutoConfiguration

# Override security.enabled to false for dev profile
security:
  enabled: false

logging:
  level:
    com.bmc.rag: DEBUG
    org.hibernate.SQL: DEBUG
    org.springframework.security: DEBUG

---
spring:
  config:
    activate:
      on-profile: prod

logging:
  level:
    root: WARN
    com.bmc.rag: INFO
    org.springframework.security: WARN

# Production hardening
management:
  endpoint:
    health:
      show-details: never
